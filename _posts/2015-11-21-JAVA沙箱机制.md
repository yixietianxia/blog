---
layout: article
title: JAVA沙箱机制
category: java
---
阅读本文之前，最好对字节校验器、类加载器有所了解
>#####什么是java沙箱机制
    Java 沙箱由三部分组成:字节码检验器,类装载器和安全管理器,这三部分共同完成装载和运行时对Java Applet的检验,用以限制对文件系统和网络的访问以及对浏览器内部的访问.
    下面具体介绍这三部分：
    1. `class文件校验器(字节码)`通过四次扫描
     第一次检查class文件的结构是否正确.class文件开头以魔术OxCAFEBABE开头.
     第二次检查它是否符合java语言特性里的编译规则。比如发现一个类的超类不是Object，就抛出异常
     第三次检查字节码是否能被JVM安全的执行，而不会导致JVM崩溃
     第四次符号引用验证。一个类文件，它会包含它引用的其他类的全名和描述符，并跟他们建立符号引用（一种虚拟的，非物理连接的方式）。当程序第一次执行到需要符号引用的位置时，jvm会检查这个符号链接的正确性，然后建立真正的物理引用(直接引用)。
    2. `类装载器`主要进行三个步骤的操作
     第一步骤--装载  
      查找并且加载二进制文件.
     第二步骤--链接
      验证确保加载类正确；为类中静态变量分配内存，初始化为默认值；把符号引用转变为直接引用
     第三步骤--初始化 
      为类中静态变量赋予真正的值
    3. `安全管理器`是一个单独的对象，在java虚拟机中，它在访问控制-对于外部资源的访问控制-起到中枢作用

>#####重点讲解类装载器
    类加载核心采用了双亲委托模型进行类加载。所谓双亲委托模型指的是优先从顶层启动类加载器开始，自顶向下的方式加载类的模型。
>   
    这种模型的好处是，底层的类装载器装载的类无法与顶层类装载器装载的类相互调用。哪怕是同包下的类，只要他们不属于同一类装载器，都是相互隔绝的。这对一些有安全隐患的类起到了安全隔离的作用。使它不能冒充系统类来破坏程序正常运作。
>
    此外，不同的类装载器，也有自己的类装载范围。比如启动类装载器，它只会装在jdk/lib目录下的包/类，因此，系统级的类是相对安全的
>
    类加载器从上往下有：BootstrapClassloader->ExtClassloader->AppClassloader->CustomClassloader.例如：当类加载器加载一个叫Student.class的类首先从CustomClassloader取是否有该类，没有在从AppClassloader去取，还是没有则从ExtClassLoader取，还没有才会从BootstrapClassloader取。 加载class首先从BootStrap开始，依次是Ext、App、Custom,如果CustomClassloader没有加载到类则会抛出ClassNotFoundException!